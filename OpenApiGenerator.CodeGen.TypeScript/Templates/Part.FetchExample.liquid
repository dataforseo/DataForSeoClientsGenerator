const username = '{{ operation.Login }}';
const password = '{{ operation.Password }}';

let api = new {{ operation.ApiName }}("https://{{ operation.Host }}", {
  fetch: (url: RequestInfo, init?: RequestInit): Promise<Response> => {
    const token = btoa(`${username}:${password}`);
    const authHeader = { 'Authorization': `Basic ${token}` };

    const newInit: RequestInit = {
      ...init,
      headers: {
      ...init?.headers,
      ...authHeader,
      {%- if operation.UserAgent != null -%}
      'User-Agent': '{{ operation.UserAgent }}',
      {%- endif -%}
      {%- if operation.ForTests != null -%}
      'X-Sandbox': 'allow',
      {%- endif -%}
    }
  };

  return fetch(url, newInit);
  }
});

{%- if operation.HttpMethod == "POST" -%}
let task = new {{ operation.RequestType.SourceType }}();
{%- for field in operation.Payload -%}
  {%- if field.Type.StructureType == "Dictionary" -%}
  task.{{ field.Name }} = {
    {%- for fieldValue in field.Type.Value.Fields -%}
      {{ fieldValue.FieldName }}: {{ fieldValue.Value.Value }},
    {%- endfor -%}
  };
  {%- elsif field.Type.StructureType == "Array" -%}
  task.{{ field.Name }} = [
    {%- for valueItem in field.Type.Value.Items -%}
      {%- if valueItem.Type == "Object" -%}
        new {{ field.Type.SourceType }}({
          {%- for objectField in valueItem.Fields -%}
          {{ objectField.FieldName }}: {{ objectField.Value.Value }},
          {%- endfor -%}
        }),
        {%- else -%}
      {{ valueItem.Value }},
      {%- endif -%}
    {%- endfor -%}
  ];
  {%- else -%}
  task.{{ field.Name }} = {{ field.Type.Value.Value }};
  {%- endif -%}
{%- endfor -%}
let response = await api.{{ operation.OperationName }}([task]);
{%- else -%}
  {%- if operation.GetParameter != null -%}
let {{ operation.GetParameter.Name }} = {{ operation.GetParameter.Type.Value.Value }};
let response = await api.{{ operation.OperationName }}({{ operation.GetParameter.Name }});
  {%- else -%}
let response = await api.{{ operation.OperationName }}();
  {%- endif -%}
{%- endif -%}
